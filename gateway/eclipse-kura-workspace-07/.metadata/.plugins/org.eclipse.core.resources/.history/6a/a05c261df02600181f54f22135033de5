package org.eclipse.kura.demo.heater;

import java.io.FilterInputStream;
import java.util.Date;

import org.eclipse.kura.KuraException;
import org.eclipse.kura.cloud.CloudClient;
import org.eclipse.kura.cloud.CloudService;
import org.eclipse.kura.message.KuraPayload;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ErrorPublisher {
	
	public ErrorPublisher(CloudService cloudService) throws KuraException {
	
		logger.info("creating publisher...");
		cloudClient=cloudService.newCloudClient(appID);
		logger.info("creating publisher...Done");
	
	}	
	
	public String topic="SensorData";
	public int qos=2;// quality of service
	public boolean retain =false;
	public final String appID="ErrorCollector";
	private double temperatureMinLimit=10.0;
	private double temperatureMaxLimit=30.0;
	private double accMaxLimit=5;
	
	private CloudClient cloudClient;
	
    private static final Logger logger = LoggerFactory.getLogger(Heater.class);
	

	public void checkData(WatchmanData data) throws Exception{
		
		if(false) {
		
			logger.info("--------start to publishing WatchmanData...");
			KuraPayload payload=new KuraPayload();
			
			payload.addMetric("SensorID", data.SensorID);
			payload.addMetric("MicroTimeStamp", data.MicroTimeStamp);
			payload.addMetric("Type","Watchman");
	
			logger.info("--------publishing add date metric data...");
			payload.setTimestamp(new Date());
			
	
			logger.info("--------add data metric data...");
	
			payload.addMetric("RedLight", (data.RedLight));
			payload.addMetric("GreenLight", (data.GreenLight));
			payload.addMetric("RedLight", (data.BlueLight));
	
			payload.addMetric("AccX", (data.AccX));
			payload.addMetric("AccY", (data.AccY));
			payload.addMetric("AccZ", (data.AccZ));
	
			payload.addMetric("Light", data.Light);
	
			payload.addMetric("Infra1", data.Infra1);
			payload.addMetric("Infra2", data.Infra2);
	
			logger.info("--------publishing data...");
			this.cloudClient.publish(topic,payload, qos, retain);
			logger.info("success!");
		
		}
		
	}
	
	public void checkData(SolarData data) throws Exception{
		if(false) {
			logger.info("--------start to publishing SolarData...");
			KuraPayload payload=new KuraPayload();
			
			payload.addMetric("SensorID", data.SensorID);
			payload.addMetric("MicroTimeStamp", data.MicroTimeStamp);
			
			payload.addMetric("Volt", data.Volt);
	
			logger.info("--------publishing add date metric data...");
			payload.setTimestamp(new Date());
	
			logger.info("--------publishing data...");
			this.cloudClient.publish(topic,payload, qos, retain);
			logger.info("success!");
			
		}
		
	}

	public void checkData(AccData data) throws Exception{
		
		double acc=Math.sqrt(Math.pow(data.AccX, 2)+Math.pow(data.AccY, 2)+Math.pow(data.AccZ, 2));
		
		if(acc>accMaxLimit) {
			KuraPayload payload=new KuraPayload();
			
			payload.addMetric("SensorID", data.SensorID);
			payload.addMetric("MicroTimeStamp", data.MicroTimeStamp);

			payload.addMetric("Cause", "QUAKE");

			payload.setTimestamp(new Date());

			logger.info("--------publishing error...");
			this.cloudClient.publish(topic,payload, qos, retain);
			logger.info("success!");
			
		}
		
	}
	
	public void checkData(DHTData data) throws Exception{

		
		if(data.Temperature>temperatureMaxLimit) {
			
			
			KuraPayload payload=new KuraPayload();
			
			payload.addMetric("SensorID", data.SensorID);
			payload.addMetric("MicroTimeStamp", data.MicroTimeStamp);

			
			payload.addMetric("Cause", "HOT");

			logger.info("--------publishing add date metric data...");
			payload.setTimestamp(new Date());

			logger.info("--------publishing data...");
			this.cloudClient.publish(topic,payload, qos, retain);
			logger.info("success!");
			
		}
		
		if(data.Temperature<temperatureMinLimit) {
			
			
			KuraPayload payload=new KuraPayload();
			
			payload.addMetric("SensorID", data.SensorID);
			payload.addMetric("MicroTimeStamp", data.MicroTimeStamp);

			
			payload.addMetric("Cause", "COLD");

			logger.info("--------publishing add date metric data...");
			payload.setTimestamp(new Date());

			logger.info("--------publishing data...");
			this.cloudClient.publish(topic,payload, qos, retain);
			logger.info("success!");
			
		}
		
		
	}
	
	public void open() throws Exception {
	}
	
	public void close() {
		this.cloudClient.release();
	}

}
